<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Big V Stat Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="row align-items-end">
            <!-- <div class="col-md-1 col-sm-0"></div> -->
            <div class="col-md-3 col-sm-6 col-6 p-3">
                <label for="divisionSelect" class="form-label">Division Group</label>
                <select id="divisionSelect" class="form-select">
                    <option value="Senior Men">Senior Men</option>
                    <option value="Senior Women">Senior Women</option>
                    <option value="Youth Men">Youth Men</option>
                    <option value="Youth Women">Youth Women</option>
                </select>
            </div>
            <div class="col-md-3 col-sm-6 col-6 p-3">
                <label for="seasonSelect" class="form-label">Season</label>
                <select id="seasonSelect" class="form-select">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                </select>

            </div>
            <div class="col-md-3 col-sm-6 col-6 p-3">
                <label for="roundSelect" class="form-label">Round</label>
                <select id="roundSelect" class="form-select">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                </select>
            </div>
            <div class="col-md-3 col-sm-6 col-6 p-3">
                <button type="button" class="btn btn-primary" onclick="fetchData()">Fetch Data</button>
            </div>
            <!-- <div class="col-md-1 col-sm-0"></div> -->
        </div>
        <div class="row">
            <div class="col p-3">
                <table class="table table-striped" id="statsTable" style="display: flex; overflow: auto;">
                    <thead>
                        <tr>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('bib')">#</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('personName')">Name</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('teamName')">Team</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('gameTitleHomeVsAway')">Game</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('competitionName')">Comp</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('minutes')">MIN</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('points')">PTS</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('fieldGoalsPercentage')">FG%</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('trueShootingPercentage')">TS%</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('foulsPersonal')">PF</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('plusMinus')">+/-</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('efficiency')">Eff</button></th>
                            <th scope="col"><button type="button" class="btn btn-link"
                                    onclick="populateTable('gameScore')">GmSc</button></th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                    </tbody>
                </table>
                <div id="progressContainer" class="progress d-none" role="progressbar" aria-label="Round data loading"
                    aria-valuemin="0" aria-valuemax="100">
                    <div id="progressBar" class="progress-bar" style="width: 0%" aria-valuenow="0"></div>
                </div>
            </div>
        </div>
        <div class="row">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"
        integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D"
        crossorigin="anonymous"></script>
    <script>

        const divisions = [
            { id: "ee3cafaa-76a3-11eb-a481-2a86bfd2d24d", name: "Championship Men", group: "Senior Men", seasons: []},
            { id: "ee4035f8-76a3-11eb-a481-2a86bfd2d24d", name: "Championship Women", group: "Senior Women", seasons: [] },
            { id: "ee43298e-76a3-11eb-a481-2a86bfd2d24d", name: "Division One Men", group: "Senior Men", seasons: [] },
            { id: "ee46747c-76a3-11eb-a481-2a86bfd2d24d", name: "Division One Women", group: "Senior Men", seasons: [] },
            { id: "ee4a0420-76a3-11eb-a481-2a86bfd2d24d", name: "Division Two Men", group: "Senior Men", seasons: [] },
            { id: "ee4d24e8-76a3-11eb-a481-2a86bfd2d24d", name: "Division Two Women", group: "Senior Men", seasons: [] },
            { id: "ee501d7e-76a3-11eb-a481-2a86bfd2d24d", name: "Victorian Youth Championship Men", group: "Youth Men", seasons: [] },
            { id: "ee53fe30-76a3-11eb-a481-2a86bfd2d24d", name: "Victorian Youth Championship Women", group: "Youth Women", seasons: [] },
            { id: "ee57fec2-76a3-11eb-a481-2a86bfd2d24d", name: "Youth League One Men", group: "Youth Men", seasons: [] },
            { id: "ee64436c-76a3-11eb-a481-2a86bfd2d24d", name: "Youth League One Women", group: "Youth Women", seasons: [] },
            { id: "ee615c24-76a3-11eb-a481-2a86bfd2d24d", name: "Youth League Two Men", group: "Youth Men", seasons: [] },
            { id: "ee6709f8-76a3-11eb-a481-2a86bfd2d24d", name: "Youth League Two Women", group: "Youth Women", seasons: [] },
            { id: "a5809a1b-b1d9-11ef-823f-656618bcf3f0", name: "Youth League Three Men", group: "Youth Men", seasons: [] }
        ];

        // --------------------
        // FETCHING AND CACHING
        // --------------------

        // Division Seasons Caching

        const divisionSeasonsCache = new Map();

        async function getCachedDivisionSeasons(divisionId) {
            if (!divisionSeasonsCache.has(divisionId)) {
                const data = await getDivisionSeasonsData(divisionId);
                divisionSeasonsCache.set(divisionId, data.data);
            }
            return divisionSeasonsCache.get(divisionId);
        }

        async function getDivisionSeasonsData(divisionId) {
            const url = "https://prod.services.nbl.com.au/api_cache/bbv/synergy";
            const params = new URLSearchParams({
                route: `competitions/${divisionId}/seasons`,
                format: "true"
            });

            try {
                const response = await fetch(`${url}?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log("Division seasons data:", data);
                    return data;
                } else {
                    console.error("Request failed:", response.status);
                }
            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // Season Games Caching
        const seasonGamesCache = new Map();

        async function getCachedSeasonGames(seasonId) {
            if (!seasonGamesCache.has(seasonId)) {
                const data = await getSeasonGamesData(seasonId);
                seasonGamesCache.set(seasonId, data.data);
            }
            return seasonGamesCache.get(seasonId);
        }

        async function getSeasonGamesData(seasonId) {
            const url = "https://prod.services.nbl.com.au/api_cache/bbv/synergy";
            const params = new URLSearchParams({
                route: `seasons/${seasonId}/fixtures`,
                format: "true"
            });

            try {
                const response = await fetch(`${url}?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log("Season games data:", data);
                    return data
                } else {
                    console.error("Request failed:", response.status);
                }
            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // Game Stats Caching
        const gameStatsCache = new Map();

        async function getCachedGameStatistics(fixtureId) {
            if (!gameStatsCache.has(fixtureId)) {
                const data = await getGameStatistics(fixtureId);
                gameStatsCache.set(fixtureId, data.data);
            }
            return gameStatsCache.get(fixtureId);
        }

        async function getGameStatistics(fixtureId) {
            const url = "https://eapi.web.prod.cloud.atriumsports.com/v1/embed/2/fixture_detail";
            const params = new URLSearchParams({
                sub: "statistics",
                fixtureId: fixtureId
            });

            try {
                const response = await fetch(`${url}?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log("Game stats:", data);
                    return data
                } else {
                    console.error("Request failed:", response.status);
                }
            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // ----------------
        // POPULATING TABLE
        // ----------------
        function fetchData() {

            divisionGroupSelection = document.getElementById('divisionSelect');
            seasonSelection = document.getElementById('seasonSelect');
            roundSelection = document.getElementById('roundSelect');

            // get selected divisions

            // get season ids for selected divisions

            // get fixture ids for selected seasons

            // start progress tracking
            
            // get game stats for selected rounds in se

            // end progress tracking

            // calculate extra stats

        }

        function populateTable(sortBy) {
            // default sort by is game score
            sortBy = sortBy || "gameScore";

            // sort players
            roundPlayers.sort((a, b) => b.statistics[sortBy] - a.statistics[sortBy]);

            // populate table with 

            // Insert top 15 rows
            const topPlayers = roundPlayers.slice(0, 15);
            const statsTableBody = document.getElementById("statsTableBody");
            statsTableBody.innerHTML = "";

            topPlayers.forEach((player, index) => {
                const stats = player.statistics;
                const row = document.createElement("tr");
                row.innerHTML = `
      <th scope="row">${player.bib}</th>
      <td>${player.personName}</td>
      <td>${player.teamName}</td>
      <td>${player.gameTitleHomeVsAway}</td>
      <td>${player.competitionName}</td>
      <td>${formatDuration(stats.minutes)}</td>
      <td>${stats.points || 0}</td>
      <td>${(stats.fieldGoalsPercentage || 0).toFixed(1)}%</td>
      <td>${(stats.trueShootingPercentage).toFixed(1)}%</td>
      <td>${stats.foulsPersonal || 0}</td>
      <td>${stats.plusMinus || 0}</td>
      <td>${stats.efficiency || 0}</td>
      <td>${stats.gameScore.toFixed(1)}</td>
    `;
                statsTableBody.appendChild(row);
            });

        }

        async function handleRoundSelect(seasonId, roundNumber) {
            // show progress bat and set it to 0%
            const progressContainer = document.getElementById("progressContainer")
            const progressBar = document.getElementById("progressBar")
            progressContainer.classList.remove("d-none");
            progressBar.style.width = "0%";
            progressBar.setAttribute("aria-valuenow", "0");

            const seasonGames = await getCachedSeasonGames(seasonId);
            const seasonGamesThisRound = seasonGames.filter(game => game.roundNumber === roundNumber);

            // get game stats and fill in player stats
            const roundPlayers = [];

            // Progress tracking
            const totalGames = seasonGamesThisRound.length;
            let completedGames = 0;

            for (const game of seasonGamesThisRound) {
                const gameStats = await getCachedGameStatistics(game.fixtureId);

                let competitionName = gameStats.banner.competition.name;
                let homeTeamName = "Unknown";
                let awayTeamName = "Unknown";
                if (gameStats.banner.fixture.competitors[0].isHome) {
                    homeTeamName = gameStats.banner.fixture.competitors[0].name;
                    awayTeamName = gameStats.banner.fixture.competitors[1].name;
                }
                else {
                    homeTeamName = gameStats.banner.fixture.competitors[1].name;
                    awayTeamName = gameStats.banner.fixture.competitors[0].name;
                }

                // fill in the stats for home team
                const homePlayers = gameStats.statistics.data.base.home.persons[0].rows;
                for (const player of homePlayers) {
                    roundPlayers.push(fillInPlayerStats(player, homeTeamName, awayTeamName));
                }

                // fill in the stats for away team
                const awayPlayers = gameStats.statistics.data.base.away.persons[0].rows;
                for (const player of awayPlayers) {
                    roundPlayers.push(fillInPlayerStats(player, awayTeamName, homeTeamName));
                }

                // Update progress
                completedGames++;
                const percent = Math.round((completedGames / totalGames) * 100);
                progressBar.style.width = `${percent}%`;
                progressBar.setAttribute("aria-valuenow", percent.toString());
            }


            // Hide progress bar and set it to 100%
            progressContainer.classList.add("d-none");
            progressBar.style.width = `100%`;
            progressBar.setAttribute("aria-valuenow", "100");

            populateTable()
        }

        // ----------------
        // HELPER FUNCTIONS
        // ----------------

        function fillInPlayerStats(player, playerTeamName, opponentTeamName, competitionName) {
            const stats = player.statistics;
            const FGA = stats.fieldGoalsAttempted || 0;
            const FTA = stats.freeThrowsAttempted || 0;
            const PTS = stats.points || 0;

            // True Shooting Percentage
            stats.trueShootingPercentage = (FGA === 0 && FTA === 0)
                ? 0
                : PTS / (2 * (FGA + 0.44 * FTA)) * 100;

            // Game Score
            stats.gameScore =
                PTS
                + 0.4 * (stats.fieldGoalsMade || 0)
                - 0.7 * FGA
                - 0.4 * ((FTA - (stats.freeThrowsMade || 0)))
                + 0.7 * (stats.reboundsOffensive || 0)
                + 0.3 * (stats.reboundsDefensive || 0)
                + (stats.steals || 0)
                + 0.7 * (stats.assists || 0)
                + 0.7 * (stats.blocks || 0)
                - 0.4 * (stats.foulsPersonal || 0)
                - (stats.turnovers || 0);

            player.teamName = playerTeamName;
            player.gameTitleHomeVsAway = playerTeamName + " vs " + opponentTeamName;
            player.competitionName = competitionName;

            return player;
        }

        function formatDuration(duration) {
            if (!duration || typeof duration !== 'string') return '0:00';

            const match = duration.match(/PT(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return '0:00';

            const minutes = parseInt(match[1] || '0', 10);
            const seconds = parseInt(match[2] || '0', 10);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

    </script>
</body>

</html>